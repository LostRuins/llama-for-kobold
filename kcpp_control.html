<!DOCTYPE html>
<html>
    <body>
        <span id="currentModel">Current model: N/A</span>
        <br/>
        <span id="lastReloadTime">Last reload took: N/A</span>
        <br/>
        <select id="prefOptions"></select>
        <select id="modelOptions"></select>
        <button id="restart">Restart server</button>
        <br />
        <select id="saveOptions"></select>
        <button id="loadFromDB">Load from DB</button>
        <button id="deleteFromDB">Delete from DB</button>
        <br />
        <input id="saveName" placeholder="Enter save name" />
        <input id="saveContent" placeholder="Enter save data (JSON content)"/>
        <button id="saveToDB">Save to DB</button>
    </body>
    <script>
        let prefOptions = document.getElementById("prefOptions"), modelOptions = document.getElementById("modelOptions"), 
        currentModelDisplay = document.getElementById("currentModel"), lastReloadTime = document.getElementById("lastReloadTime"), restart = document.getElementById("restart"),
        saveOptions = document.getElementById("saveOptions"), loadSave = document.getElementById("loadFromDB"),
        deleteFromDB = document.getElementById("deleteFromDB"), saveToDB = document.getElementById("saveToDB"),
        saveName = document.getElementById("saveName"), saveContent = document.getElementById("saveContent");

        let isKoboldLive = () => fetch("control/live")
            .then(resp => resp.text())
            .then(state => {
                return state === "Online"
            })
            .catch(e => {
                return false
            })

        let waitForKoboldThen = (doThis, timeout = 3) => {
            setTimeout(async () => {
                if (await isKoboldLive())
                {
                    doThis()
                }
                else
                {
                    waitForKoboldThen(doThis, 1)
                }
            }, timeout * 1000)
        }

        let reloadCurrentConfig = () => {
            fetch("control/configs/current")
                .then(resp => resp.text())
                .then(currentConfig => {
                    let optionElem = prefOptions.querySelector(`[value='${currentConfig}']`)
                    if (!!optionElem) {
                        optionElem.selected = true
                    }
                })
                .catch(e => {
                    console.error(e)
                })
        }

        let reloadCurrentModel = () => {
            fetch("control/models/current")
                .then(resp => resp.text())
                .then(currentModel => {
                    currentModelDisplay.innerText = `Current model: ${currentModel}`
                })
                .catch(e => {
                    console.error(e)
                })
        }
        
        restart.onclick = () => {
            fetch("control/restart", {
                method: "POST",
                body: JSON.stringify({"config": prefOptions.value, "model": modelOptions.value})
            })
            .then(resp => resp.text())
            .then(resp => {
                startTime = Date.now()
                waitForKoboldThen(() => {
                    let timeToChangeInSeconds = (Date.now() - startTime) / 1000
                    lastReloadTime.innerText = `Last reload took: ${timeToChangeInSeconds}`
                    reloadCurrentConfig()
                    reloadCurrentModel()
                })
                console.log(resp)
            })
            .catch(e => {
                console.error(e)
            })
        }

        fetch("control/configs")
            .then(resp => resp.json())
            .then(arr => {
                arr.forEach(elem => {
                    prefOptions.appendChild(new Option(elem, elem))
                });
            })
            .then(() => {
                // After getting the configs, find the current one and set it
                reloadCurrentConfig()
            })
            .catch(e => {
                console.error(e)
            })
        
        modelOptions.appendChild(new Option("Default", ""))
        fetch("control/models")
            .then(resp => resp.json())
            .then(arr => {
                arr.forEach(elem => {
                    modelOptions.appendChild(new Option(elem, elem))
                });
            })
            .then(() => {
                // After getting the models, find the current one and set it
                reloadCurrentModel()
            })
            .catch(e => {
                console.error(e)
            })

        reloadSaves = () => {
            saveOptions.innerHTML = ""
            fetch("control/saves")
                .then(resp => resp.json())
                .then(arr => {
                    arr.forEach(elem => {
                        saveOptions.appendChild(new Option(elem, elem))
                    });
                })
                .catch(e => {
                    console.error(e)
                })
        }
        reloadSaves()

        loadSave.onclick = () => {
            fetch(`control/saves/get/${encodeURIComponent(saveOptions.value)}`)
                .then(resp => resp.json())
                .then(saveData => {
                    try
                    {
                        let saveJson = atob(saveData)
                        console.log(JSON.parse(saveJson))
                    }
                    catch (e)
                    {
                        console.log(saveData)
                    }
                    alert("Save loaded - check console")
                })
                .catch(e => {
                    console.error(e)
                })
        }

        saveToDB.onclick = () => {
            fetch(`control/saves/put/${encodeURIComponent(saveName.value)}`, {method: "POST",
                    body: btoa(saveContent.value)
                })
                .then(resp => resp.text())
                .then(message => {
                    alert(message)
                    reloadSaves()
                })
                .catch(e => {
                    console.error(e)
                })
        }

        deleteFromDB.onclick = () => {
            fetch(`control/saves/delete/${encodeURIComponent(saveOptions.value)}`,  {method: "POST"})
                .then(resp => resp.text())
                .then(message => {
                    alert(message)
                    reloadSaves()
                })
                .catch(e => {
                    console.error(e)
                })
        }
    </script>
</html>